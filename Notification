import javax.swing.*;
import java.awt.*;
import java.io.*;
import java.text.SimpleDateFormat;
import java.util.*;
import java.util.List;

public class Notification extends JPanel {
    private JTextArea notifArea;
    private JButton refreshBtn;
    private String username;

    public Notification(String username) {
        this.username = username;

        setLayout(new BorderLayout(10, 10));
        setBorder(BorderFactory.createEmptyBorder(20, 20, 20, 20));
        setBackground(new Color(245, 245, 245));

        JLabel title = new JLabel("Notifications", JLabel.CENTER);
        title.setFont(new Font("Segoe UI", Font.BOLD, 22));
        title.setForeground(new Color(0, 100, 150));
        add(title, BorderLayout.NORTH);

        notifArea = new JTextArea();
        notifArea.setEditable(false);
        notifArea.setFont(new Font("Segoe UI", Font.PLAIN, 14));
        notifArea.setBorder(BorderFactory.createLineBorder(new Color(0, 150, 136), 2));
        notifArea.setBackground(new Color(255, 255, 245)); 
        add(new JScrollPane(notifArea), BorderLayout.CENTER);

        JPanel bottomPanel = new JPanel();
        bottomPanel.setBackground(new Color(230, 245, 255));
        refreshBtn = new JButton("Refresh Notifications");
        styleButton(refreshBtn, new Color(0, 150, 136));
        bottomPanel.add(refreshBtn);
        add(bottomPanel, BorderLayout.SOUTH);

        refreshBtn.addActionListener(e -> loadNotifications());

        loadNotifications();
    }

    public void loadNotifications() {
        notifArea.setText("");
        List<String> notifications = new ArrayList<>();

        loadFile("approved_appointments.txt", (parts) -> {
            if (parts.length >= 3 && parts[0].equals(username)) {
                String msg = String.format(
                    "Appointment Approved!\nDoctor: %s\nDate: %s\nTime: %s\n--------------------------------------\n",
                    parts[1], parts[2], getCurrentTime());
                notifications.add(msg);
                return true;
            }
            return false;
        });

        loadFile("declined_appointments.txt", (parts) -> {
            if (parts.length >= 2 && parts[0].equals(username)) {
                String msg = String.format(
                    "Appointment Declined\nReason: %s\nTime: %s\n--------------------------------------\n",
                    parts[1], getCurrentTime());
                notifications.add(msg);
                return true;
            }
            return false;
        });

        loadFile("medicine_advice.txt", (parts) -> {
            if (parts.length >= 2 && parts[0].equals(username)) {
                String msg = String.format(
                    "Medicine Request Approved!\nPrescription: %s\nTime: %s\n--------------------------------------\n",
                    parts[1], getCurrentTime());
                notifications.add(msg);
                return true;
            }
            return false;
        });

        loadFile("declined_medicine.txt", (parts) -> {
            if (parts.length >= 2 && parts[0].equals(username)) {
                String msg = String.format(
                    "Medicine Request Declined\nReason: %s\nTime: %s\n--------------------------------------\n",
                    parts[1], getCurrentTime());
                notifications.add(msg);
                return true;
            }
            return false;
        });

        Collections.reverse(notifications);

        if (notifications.isEmpty()) {
            notifArea.setText("No notifications yet.");
        } else {
            for (String notif : notifications) {
                notifArea.append(notif);
            }
        }

        notifArea.setCaretPosition(0);
    }

    private boolean loadFile(String fileName, FileProcessor processor) {
        boolean found = false;
        File file = new File(fileName);
        if (file.exists()) {
            try (BufferedReader br = new BufferedReader(new FileReader(file))) {
                String line;
                while ((line = br.readLine()) != null) {
                    String[] parts = line.split(",", 3);
                    if (processor.process(parts)) found = true;
                }
            } catch (IOException e) {
                notifArea.append("Error reading " + fileName + "\n");
            }
        }
        return found;
    }

    private String getCurrentTime() {
        SimpleDateFormat sdf = new SimpleDateFormat("MMMM dd, yyyy - hh:mm a");
        return sdf.format(new Date());
    }

    private interface FileProcessor {
        boolean process(String[] parts);
    }

    private void styleButton(JButton button, Color color) {
        button.setBackground(color);
        button.setForeground(Color.WHITE);
        button.setFocusPainted(false);
        button.setBorderPainted(false);
        button.setOpaque(true);
        button.setCursor(new Cursor(Cursor.HAND_CURSOR));

        button.addMouseListener(new java.awt.event.MouseAdapter() {
            public void mouseEntered(java.awt.event.MouseEvent evt) { button.setBackground(color.darker()); }
            public void mouseExited(java.awt.event.MouseEvent evt) { button.setBackground(color); }
        });
    }

    public static void main(String[] args) {
        SwingUtilities.invokeLater(() -> {
            JFrame frame = new JFrame("User Notifications");
            frame.setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);
            frame.setSize(700, 500);
            frame.add(new Notification("testuser"));
            frame.setLocationRelativeTo(null);
            frame.setVisible(true);
        });
    }
}
